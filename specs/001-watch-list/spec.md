# Feature Specification: 視聴予定リスト

**Feature Branch**: `001-watch-list`
**Created**: 2025-11-19
**Status**: Draft
**Input**: User description: 「視聴予定リスト」機能を定義する。
- ドラマ/アニメ/映画を「視聴予定」として登録できる
- それぞれタイトル、シーズン、エピソード、URLを持つ
- 視聴状態は「未視聴」「視聴中」「視聴済み」
- 視聴済みの日時、評価、感想を残せる
- 検索・フィルタ（タイトル、サービス、視聴状態）をサポート

## User Scenarios & Testing *(mandatory)*

<!--
  IMPORTANT: User stories should be PRIORITIZED as user journeys ordered by importance.
  Each user story/journey must be INDEPENDENTLY TESTABLE - meaning if you implement just ONE of them,
  you should still have a viable MVP (Minimum Viable Product) that delivers value.
  
  Assign priorities (P1, P2, P3, etc.) to each story, where P1 is the most critical.
  Think of each story as a standalone slice of functionality that can be:
  - Developed independently
  - Tested independently
  - Deployed independently
  - Demonstrated to users independently
-->

### User Story 1 - タイトルと複数シリーズを登録する (Priority: P1)

ユーザーは、これから視聴したいドラマ・アニメ・映画のタイトルを「視聴予定」として登録できます。UI上は、タイトルに0以上のシリーズが紐付き、シリーズに0以上のエピソードが紐付く階層構造です。シリーズが1つだけの場合はシリーズレイヤーを非表示にしてタイトル直下にエピソードを表示し、エピソードが1つだけの場合はエピソードレイヤーを非表示にして単純なエントリとして表示します。単発の映画の場合、シリーズ・エピソード構造は不要で、タイトル単体で視聴履歴を記録できます。内部的には、すべてのタイトルは必ず1つのシリーズを持ち、すべてのシリーズは必ず1つのエピソードを持つ統一的なデータモデルで実装されます。タイトルに関する情報ウェブページ（Wikipedia、IMDb等）のURLを複数登録することもできます。各エピソードには、複数の視聴ページURL（異なるサービス配信先）を登録できます。

**Why this priority**: アプリケーションの基本的な価値は、ユーザーが視聴予定を管理することであり、この機能なしにはシステム全体が成り立たない。複数シリーズ対応により、シリーズ作品全体の管理が可能。UXの最適化により、単一シリーズ作品の操作を簡潔に。

**Independent Test**: 単一シリーズ作品を登録しエピソードをタイトル直下に追加できることを確認でき、その後シリーズを追加してエピソードが自動的に1つ目のシリーズに移動することで確認できます。複雑な階層構造とシンプルなUXの両立が可能。

**Acceptance Scenarios**:

1. **Given** ユーザーが新規タイトル登録フォームを開いた状態 **When** タイトル名を入力して送信 **Then** 新しいタイトルがリストに追加される
2. **Given** 単発映画のタイトルが登録された状態 **When** UI上でそのタイトルを確認 **Then** シリーズレイヤー・エピソードレイヤーなしで、タイトル単体として表示される
3. **Given** シリーズが1つだけある状態 **When** UI上でそのタイトルを確認 **Then** シリーズレイヤーは非表示で、エピソードがタイトル直下に表示される
4. **Given** シリーズが1つだけでエピソードが1つだけの状態 **When** UI上でそのタイトルを確認 **Then** シリーズレイヤー・エピソードレイヤーの両方が非表示で、単純なエントリとして表示される
5. **Given** シリーズが複数ある状態 **When** ユーザーがシリーズを確認 **Then** シリーズレイヤーが表示され、各シリーズ配下にエピソードが表示される
6. **Given** エピソードが登録されている状態 **When** ユーザーが複数の視聴ページURLを登録 **Then** すべてのURLがエピソード配下に表示される
7. **Given** タイトルが登録されている状態 **When** ユーザーがタイトル情報URL（Wikipedia等）を登録 **Then** そのURLがタイトルレベルで表示される

---

### User Story 2 - 視聴状態と視聴履歴を管理する (Priority: P1)

ユーザーは、リスト内の各作品の視聴状態を「未視聴」から「視聴済み」に変更できます。視聴済みに変更した際には、視聴完了日時、評価、感想を記録できます。同じ作品を複数回視聴した場合、複数の視聴履歴として記録できます。一度「視聴済み」に変更されたエントリは、その状態を変更することはできません。

**Why this priority**: 視聴状態の管理がなければリストは単なる願い事リストになり、実際の視聴進捗を追跡することができない。複数回視聴の記録により、好きな作品の再視聴履歴を管理できる。

**Independent Test**: 作品の視聴状態を「未視聴」から「視聴済み」に変更でき、複数回の視聴履歴（日時、評価、感想）を記録して保存できることで確認できます。

**Acceptance Scenarios**:

1. **Given** 新しく登録されたエントリ **When** ユーザーが視聴を完了 **Then** 状態を「視聴済み」に変更して完了日時、評価（1-5）、感想を入力できる
2. **Given** 視聴状態が「視聴済み」のエントリ **When** 詳細を表示 **Then** 視聴履歴一覧が表示される（複数回の視聴記録がある場合は全て表示）
3. **Given** 視聴状態が「視聴済み」のエントリ **When** 新しい視聴を記録 **Then** 新しい視聴履歴が追加される（既存の視聴履歴は保持）
4. **Given** 複数の視聴履歴があるエントリ **When** 各視聴履歴を表示 **Then** すべての視聴履歴（日時、評価、感想）が表示される

---

### User Story 3 - リストを検索・フィルタする (Priority: P2)

ユーザーは、視聴予定リストが増えた際に、タイトルや視聴状態で検索・フィルタできます。これにより、次に何を見るかや、見たい状態の作品を素早く見つけることができます。

**Why this priority**: リストが小規模なうちは必須ではないが、コンテンツが増えると効率的にアクセスするために重要。ユーザーの長期的な満足度に大きく影響。

**Independent Test**: 複数の作品が登録された状態で、特定のタイトルで検索したり、視聴状態でフィルタして、対応する結果のみが表示されることで確認できます。

**Acceptance Scenarios**:

1. **Given** 複数の作品が登録されている状態 **When** タイトルの一部を入力して検索 **Then** 該当するエントリのみが表示される
2. **Given** 「未視聴」と「視聴済み」のエントリが混在している **When** 「未視聴」でフィルタ **Then** 未視聴のエントリのみが表示される
3. **Given** 「未視聴」と「視聴済み」のエントリが混在している **When** 「視聴済み」でフィルタ **Then** 視聴済みのエントリのみが表示される
4. **Given** 検索またはフィルタを実行した状態 **When** フィルタをクリア **Then** すべてのエントリが再度表示される

### Edge Cases

#### 重複登録・入力検証

- ユーザーが同じタイトルを複数回登録した場合：**完全に同じタイトル名の登録は拒否** ✅
- エピソード番号やシリーズ名が重複する場合の扱い
- エントリから同じURLを複数回登録した場合：**システムが自動的に検出・削除** ✅

#### URL管理とバリデーション

- URLが無効または削除されたサービスページになった場合のユーザーへの通知
- URLなし（視聴ページなし）で登録された場合の扱い。リスト表示時やアクセス時の動作確認
- 1つのエピソードに複数のURL（10件以上）がある場合の表示方法・パフォーマンス
- 視聴ページURLが長い場合（500文字以上）のテキスト表示・切り詰め方法
- URLの有効性自動チェック機能（実装するのか、スコープ外か）

#### シリーズ階層構造とUX最適化（内部構造 vs UI表示分離）

- 内部では常に「タイトル→シリーズ→エピソード」の3階層が存在することの確認
  - すべてのタイトルが最低限1つのシリーズを持つ
  - すべてのシリーズが最低限1つのエピソードを持つ
- UI表示時の条件付き非表示動作確認
  - シリーズが1つだけ→シリーズレイヤーを非表示。UI上ではタイトル→エピソードのみ表示。ただし、内部的にはシリーズが存在。
  - エピソードが1つだけ→エピソードレイヤーを非表示。UI上ではタイトルまたはシリーズ単体で表示。ただし、内部的にはエピソードが存在。
  - シリーズが複数→シリーズレイヤーを表示。タイトル→シリーズ→エピソードの完全な階層を表示。
- 単発映画での動作確認
  - デフォルトシリーズとデフォルトエピソードが自動的に作成される
  - UI上ではシリーズ・エピソード層が両方非表示。タイトル単体として見える。
  - ユーザーはシリーズやエピソード追加操作をしない限り、この状態が維持される。
- 複数シリーズ状態で1つのシリーズを削除した場合、残りが1つになったときのUI動作：
  - **シリーズが1つに戻ったら、UI上もシリーズレイヤーを非表示に戻す（動的切り替え）** ✅
  - この動作により、シリーズ数に応じた UI 層の可視性が常に同期される
- 複数シリーズ間でのエピソード移動が必要な場合（シリーズの統合等）の処理方法
- シリーズの自動名前付け（「Season 1」「Season 2」等）と手動命名のルール
- エピソード追加時に、シリーズが1つの場合と複数の場合での操作フローの差異
- シリーズが1つで UI 層が非表示の状態でシリーズを追加する際のアクセス方法：**タイトル詳細画面に「シリーズを追加」ボタンを配置** ✅
- UI層の非表示によるデータ削除の誤り防止（単に表示非表示ではなく、データは保持される点の強調）

#### 視聴状態と視聴履歴

- ユーザーが誤って「視聴済み」に変更した場合。状態は変更できない（削除機能で対応）
- エピソードから視聴履歴をすべて削除した場合。エピソードは「未視聴」状態に戻す
- エピソード自体を削除する場合。紐付く視聴履歴も一緒に完全削除（物理削除）される
- 視聴完了日時が現在日時より未来の日付の場合の検証方法
- エピソード単位で「視聴済み」だが、複数視聴記録が存在する場合の表示順序：**最新の視聴履歴が最初に表示される（新しい順）** ✅
- 視聴履歴が非常に多い場合（100件以上）の表示パフォーマンスとページネーション

#### パフォーマンスと大規模データ

- 非常に大量のタイトル（1000件以上）またはタイトルあたりの視聴履歴が多い場合（100件以上）のパフォーマンス
- 1つのタイトル配下に100シリーズ以上存在する場合の表示・フィルタパフォーマンス
- 1つのシリーズ配下に1000エピソード以上存在する場合のスクロール・検索パフォーマンス
- 大量の視聴ページURLおよびタイトル情報URL（各10件以上）がある場合の読み込み速度

#### 不完全なデータと例外ケース

- シーズンやエピソード情報が不完全な作品（映画など。シリーズ構造を持たない）を登録する際の扱い
  - 映画は本来1シリーズ1エピソードでモデル化されるべきか、それともシリーズ構造を完全にスキップするか
- 作品が複数の媒体で配信される場合（アニメが映画化、ドラマが劇場版等）の構造化方法
- 同じエピソードがURLレベルで複数のサービスで配信されている場合の表示・管理方法

## Requirements *(mandatory)*

<!--
  ACTION REQUIRED: The content in this section represents placeholders.
  Fill them out with the right functional requirements.
-->

### Functional Requirements

- **FR-001**: システムはユーザーがタイトルを作成できる機能を提供すること。タイトルは最小限、作品名の情報を持つこと。同一タイトルの重複登録は拒否すること（完全一致チェック）。
- **FR-001-1**: 単発映画など、シリーズ・エピソード構造を持たない作品をタイトル単体で登録できること。この場合、UI上ではシリーズ・エピソードレイヤーは非表示となる。
- **FR-002**: ユーザーはタイトルの配下に複数のシリーズ（Season 1、Season 2等）を追加できること。内部的には、すべてのタイトルは最低限1つのシリーズを持つこと。
- **FR-002-1**: シリーズが1つだけの場合、UI上ではシリーズレイヤーを表示せず、エピソードをタイトル直下に紐付けること（UX最適化）。
- **FR-002-2**: 2つ目のシリーズが追加される際、既存のエピソードを自動的に1つ目のシリーズに移動し、UIをシリーズ階層表示に切り替えること。
- **FR-002-3**: シリーズが1つだけでシリーズレイヤーが非表示の場合、タイトル詳細画面に「シリーズを追加」ボタンを配置して、ユーザーがシリーズを追加できるようにすること。
- **FR-002-4**: シリーズ数に応じてUI層を動的に切り替えること。シリーズが1つに戻った場合、UI上でもシリーズレイヤーを非表示に戻すこと。
- **FR-003**: ユーザーはシリーズの配下に（または、シリーズが1つの場合はタイトル配下に）複数のエピソード情報を追加できること。各エピソードは、エピソード情報（「第1話」等）を持つこと。内部的には、すべてのシリーズは最低限1つのエピソードを持つこと。
- **FR-003-1**: エピソードが1つだけの場合、UI上ではエピソードレイヤーを表示せず、そのエントリを単純な視聴記録対象として扱うこと（UX最適化）。
- **FR-004**: ユーザーは各エピソードに対して、複数の視聴ページURL（異なるサービスでの配信リンク）を登録できること。URLは0件以上複数登録可能。システムはバックエンド側で同じURLの重複を自動的に検出・削除すること。基本的な URL 形式チェックもバックエンドで実施。
- **FR-005**: ユーザーはタイトルレベルで、タイトル情報ウェブページ（Wikipedia、IMDb等）のURLを複数登録できること。タイトル情報URLについても、バックエンド側で重複は自動的に削除されること。形式チェックもバックエンド側で実施。
- **FR-006**: システムはバックエンド DB を使用してすべてのタイトル、シリーズ、エピソード、URL、視聴履歴を永続化し、セッション間で保持すること。フロントエンドはサーバーサイド API を介してデータにアクセスすること。
- **FR-007**: ユーザーはエピソードの視聴状態を「未視聴」から「視聴済み」に変更できること。一度「視聴済み」に変更されたエピソードは、その状態を変更することはできないこと。視聴履歴はエピソードに紐付くこと。
- **FR-008**: ユーザーはエピソードを「視聴済み」に変更する際、完了日時、評価（1-5の数値）、自由形式の感想を記録できること。
- **FR-009**: ユーザーは「視聴済み」のエピソードに対して、複数回の視聴履歴を追加できること。各視聴履歴は独立した完了日時、評価、感想を持つこと。視聴履歴一覧は最新の履歴が最初に表示される（新しい順、降順）こと。
- **FR-010**: システムはタイトルによる部分一致検索をサポートすること。
- **FR-011**: システムは視聴状態（未視聴、視聴済み）によるフィルタリングをサポートすること。
- **FR-012**: ユーザーはエピソードに登録された複数のURLおよびタイトル情報URLをクリックして対応するウェブページへアクセスできること。
- **FR-013**: ユーザーはエピソードに対して視聴ページURLを追加・削除でき、タイトルに対してタイトル情報URLを追加・削除できること。
- **FR-014**: ユーザーはタイトル、シリーズ、エピソード、視聴履歴一覧の詳細情報を表示・編集・削除できること。
- **FR-014-1**: シリーズまたはタイトルを削除する際は、削除前に確認ダイアログを表示して、ユーザーの意図を確認すること。削除が確認されると、該当するシリーズ配下のエピソード・視聴履歴、またはタイトル配下のすべてのシリーズ・エピソード・視聴履歴が一緒にカスケード削除されること。
- **FR-015**: システムはシリーズの作成日時および更新日時を記録すること。シーズン名の変更や配下のエピソードの追加・削除などシリーズが変更される際に、更新日時を更新すること。
- **FR-016**: ユーザーがエピソードのすべての視聴履歴を削除した場合、そのエピソードの視聴状態を「未視聴」に戻すこと。（「視聴済み」から「未視聴」への状態遷移が可能な唯一のケース）

### Key Entities *(include if feature involves data)*

**データモデル**: 内部的には、すべてのタイトルが最低限1つのシリーズを持ち、すべてのシリーズが最低限1つのエピソードを持つ統一的な階層構造を採用。UI上では、層数に応じて表示レイヤーを条件付きで非表示にして、ユーザー体験を最適化。

- **タイトル（Title）**:
  - 作品名（文字列）: ドラマ・アニメ・映画の名前
  - タイトル情報URL（リスト）: 0件以上の情報ウェブページリンク（Wikipedia、IMDb等）
  - シリーズ（リスト）: **内部的には必ず1件以上**の関連シリーズ。UI上では0件以上として表示可能。
  - 作成日時（日時）: タイトルを登録した日時
  - 更新日時（日時）: 最後に更新した日時

- **シリーズ（Series）** - 1つのタイトルに複数存在可能:
  - ID: シリーズの一意識別子
  - シーズン名（文字列）: 「Season 1」「Season 2」等
  - エピソード（リスト）: **内部的には必ず1件以上**のエピソード情報。UI上では0件以上として表示可能。
  - 作成日時（日時）: シリーズを追加した日時
  - 更新日時（日時）: 最後に更新した日時

- **エピソード（Episode）** - 1つのシリーズに複数存在可能:
  - ID: エピソードの一意識別子
  - エピソード情報（文字列）: 「第1話」「全12話」等。単発映画の場合はエピソード情報が空またはデフォルト値
  - 視聴ページURL（リスト）: 0件以上の視聴ページリンク。各URLはクリック可能
  - 視聴状態（列挙型）: 「未視聴」「視聴済み」
  - 視聴履歴（リスト）: **エピソードに紐付く**0件以上の視聴記録
  - 作成日時（日時）: エピソードを追加した日時
  - 更新日時（日時）: 最後に更新した日時

- **視聴履歴（Viewing Record）** - 1つのエピソードに複数存在可能:
  - ID: 視聴履歴の一意識別子
  - 視聴完了日時（日時）: 視聴を完了した日時
  - 評価（数値、1-5）: ユーザーの評価スコア
  - 感想（テキスト）: ユーザーが入力した自由形式のテキスト
  - 記録日時（日時）: 視聴履歴を記録した日時

## Success Criteria *(mandatory)*

<!--
  ACTION REQUIRED: Define measurable success criteria.
  These must be technology-agnostic and measurable.
-->

### Technology Stack

- **フロントエンド**: Next.js + React + TypeScript
- **バックエンド API**: REST API（JSON形式）
- **データベース**: TBD（バックエンド実装時に決定）
- **通信プロトコル**: HTTP/HTTPS

### Measurable Outcomes

- **SC-001**: ユーザーは新しいタイトルを1分以内に作成・登録できること。
- **SC-002**: ユーザーはタイトル配下にシリーズを追加し、シリーズ配下にエピソードを追加できること。複雑な階層構造でも操作が直感的であること。
- **SC-003**: タイトル検索および状態フィルタは1秒以内に結果を表示できること。
- **SC-004**: システムは最小限500個のタイトル、および各タイトルあたり複数のシリーズ・エピソード、複数のURLを安定して管理できること（拡張時は1000タイトル以上）。
- **SC-005**: ユーザーは登録されたすべてのデータ（タイトル、シリーズ、エピソード、視聴ページURL、タイトル情報URL、視聴状態、複数の視聴履歴）を正確に保持・確認できること。
- **SC-006**: ユーザーは同じエピソードの複数回視聴を記録でき、各視聴履歴を独立した情報（日時、評価、感想）として保持できること。
- **SC-007**: 視聴予定の登録から検索まで、主要なユーザータスク（タイトル登録、シリーズ・エピソード追加、状態変更、視聴履歴記録、フィルタリング）を初回から正確に実行できること。

## Assumptions

- ユーザーはドラマ・アニメ・映画の一般的な構造（シーズン、エピソード）に理解がある。
- **内部データ構造**: すべてのタイトルは最低限1つのシリーズを持ち、すべてのシリーズは最低限1つのエピソードを持つ統一的な階層モデル。これにより、実装時の分岐ロジックを削減。
- **UI表示層**: 内部構造とは独立したUI層で、条件に応じてレイヤーを非表示にする。
  - シリーズが1つだけ：シリーズレイヤーを非表示。ユーザーはエピソードをタイトル直下に追加していると感じる。
  - エピソードが1つだけ：エピソードレイヤーを非表示。単発映画として表示。
  - シリーズが複数：シリーズレイヤーを表示。階層構造を完全に表示。
- 2つ目のシリーズが追加される際、既存のエピソードは自動的に「Season 1」（または追加されるシリーズの直前のシリーズ）として処理される。UI上もシリーズ階層表示に自動切り替わる。
- 単発映画の場合、デフォルトシリーズ（名前なし、またはデフォルト値）とデフォルトエピソード（無名、またはデフォルト値）を内部で持つが、UI上では非表示。
- 視聴履歴はエピソード単位で紐付けられる。シリーズやタイトルレベルでの視聴履歴集計表示は初期実装外。
- 視聴ページURLおよびタイトル情報URLはユーザーが入力・管理する。システムはサービス情報を管理しない。
- エピソード単位で0件以上の視聴ページURL、タイトル単位で0件以上のタイトル情報URLを登録可能。同じURLの重複登録は許可。
- 複数のURLがある場合、ユーザーが任意のURLを選択してアクセスできる。
- 評価は1-5の数値スケール。その他の形式（☆マーク等）は実装段階で決定。
- 複数回視聴履歴は1つのエピソードに対して無制限に追加可能。各視聴は独立した日時、評価、感想を持つ。
- 各視聴履歴は削除可能（視聴履歴削除機能）。視聴履歴がすべて削除された場合、エピソードの状態は「未視聴」に戻される。
- URL検証は基本的なリンク形式確認。リンク先の有効性確認はスコープ外。同一URL の重複登録は、システムが自動的に検出・削除する。
- 初期リリースでは複雑なソート機能（追加順、評価順など）は実装対象外。視聴履歴は新しい順（降順）で表示される。
- 同一タイトルの重複登録は拒否される。完全一致チェックにより、同じ作品を誤って重複登録することを防ぐ。
- シリーズレイヤーが非表示の状態でも、タイトル詳細画面に「シリーズを追加」ボタンが配置されており、ユーザーはそこからシリーズを追加できる。
- シリーズ数に応じた UI 層の可視性は動的に変わる。シリーズが1つに戻った場合、シリーズレイヤーは自動的に非表示に戻る。

## Clarifications

### Session 2025-11-19

- Q: 複数シリーズ状態での層表示の取り扱い → A: シリーズが1つに戻ったら、UI上もシリーズ層を非表示に戻す（動的切り替え）
- Q: 同一タイトルの重複登録チェック → A: 完全に同じタイトル名の登録は拒否する
- Q: 複数視聴履歴の表示順序 → A: 最新の視聴履歴が最初に表示される（新しい順）
- Q: シリーズ層が非表示の場合のシリーズ追加操作フロー → A: タイトル詳細画面に「シリーズを追加」ボタンを配置
- Q: URL重複登録の取り扱い → A: システムが同じURLの重複を自動的に検出・削除
- Q: データ永続化方式 → A: バックエンド DB のみ（サーバーサイド永続化）
- Q: UI 実装テクノロジー → A: Next.js + React + REST API
- Q: URL バリデーション実装責任 → A: バックエンド側で実装（フロントエンドは補助的確認のみ）
- Q: エピソード削除時の視聴履歴管理 → A: 物理削除（エピソードと紐付く視聴履歴も完全に削除）
- Q: タイトル・シリーズ削除時のカスケード削除 → A: カスケード削除（確認ダイアログ付き、下位データも完全削除）
- Q: シリーズの更新日時記録 → A: シリーズにも更新日時を記録する（シーズン名変更等の更新時に更新）
- Q: すべての視聴履歴削除時の状態遷移 → A: エピソードを「未視聴」状態に戻す（状態を変更不可から変更可能にする唯一のケース）

## Out of Scope

- 視聴サービスのマスターデータ管理（新規サービスの追加・削除・編集機能）
- 他のユーザーとのリスト共有機能
- ソーシャルメディアへの連携
- 自動通知機能（新エピソード配信時など）
- レコメンデーション機能
- 複数デバイス間の同期（初期リリース段階）
